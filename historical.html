<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barkley Fall Classic - Historical Analysis (2015-2025)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: white;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
        }

        h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            color: #666;
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .nav-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .nav-btn {
            background: #667eea;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            text-decoration: none;
            cursor: pointer;
            transition: background 0.3s;
            font-size: 0.9em;
        }

        .nav-btn:hover {
            background: #764ba2;
        }

        .nav-btn.active {
            background: #764ba2;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            position: relative;
            height: 400px;
        }

        .chart-title {
            color: #667eea;
            font-size: 1.3em;
            margin-bottom: 20px;
            font-weight: bold;
        }

        canvas {
            max-height: 100%;
        }

        .data-table {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .table-title {
            background: #667eea;
            color: white;
            padding: 20px;
            font-size: 1.2em;
            font-weight: bold;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f5f5f5;
            padding: 15px;
            text-align: left;
            font-weight: bold;
            color: #333;
            border-bottom: 2px solid #eee;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        tr:hover {
            background: #f9f9f9;
        }

        .finish-rate {
            font-weight: bold;
            color: #27ae60;
        }

        .low-finish-rate {
            color: #e74c3c;
        }

        .insights {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .insights h2 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .insight-item {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .insight-item:last-child {
            border-bottom: none;
        }

        .insight-label {
            font-weight: bold;
            color: #333;
        }

        .insight-value {
            color: #666;
            margin-top: 5px;
        }

        footer {
            text-align: center;
            color: white;
            padding: 20px;
            margin-top: 30px;
        }

        .note {
            color: #555;
            font-size: 0.9em;
            margin: 10px 0 20px 0;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üèîÔ∏è Barkley Fall Classic</h1>
            <p class="subtitle">Historical Analysis (2015-2025)</p>
            <p class="subtitle" style="font-size: 0.9em; color: #999;">11 Years of Race Data</p>
            <div class="nav-buttons">
                <a href="index.html" class="nav-btn">‚Üê Back to Tracker</a>
                <a href="historical.html" class="nav-btn active">Historical Analysis</a>
            </div>
        </header>

        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-label">Total Starters (DNS Excluded)</div>
                <div class="stat-value" id="totalStarters">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">50K Finishers</div>
                <div class="stat-value" id="totalFinishers50k">-</div>
                <div class="stat-change" id="pct50k">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Marathon Finishers</div>
                <div class="stat-value" id="totalFinishersMarathon">-</div>
                <div class="stat-change" id="pctMarathon">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">DNF (All Starters)</div>
                <div class="stat-value" id="totalDnf">-</div>
                <div class="stat-change" id="pctDnf">-</div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-container" style="grid-column: span 2;">
                <div class="chart-title">Outcome Distribution by Year (Single Race, Starter-based %)</div>
                <canvas id="outcomeStackedChart"></canvas>
            </div>
            <div class="chart-container">
                <div class="chart-title">Finish Rate by Distance (2015-2025)</div>
                <canvas id="finishRateChart"></canvas>
            </div>
            <div class="chart-container">
                <div class="chart-title">Participant Status Distribution (Latest Year)</div>
                <canvas id="statusChart"></canvas>
            </div>
        </div>

        <p class="note">Note: 2016 and 2017 have missing DNF data; 2020 was virtual. These years are shown per-year but excluded from aggregate stats to avoid skew.</p>

        <div class="insights">
            <h2>üìä Key Insights</h2>
            <div class="insight-item">
                <div class="insight-label">Difficulty Trend:</div>
                <div class="insight-value" id="difficultyTrend">Loading...</div>
            </div>
            <div class="insight-item">
                <div class="insight-label">Most Challenging Year (Marathon):</div>
                <div class="insight-value" id="mostChallenging">Loading...</div>
            </div>
            <div class="insight-item">
                <div class="insight-label">Best Year (Marathon):</div>
                <div class="insight-value" id="bestYear">Loading...</div>
            </div>
            <div class="insight-item">
                <div class="insight-label">50K Finish Rates:</div>
                <div class="insight-value" id="fiftyKInsight">Loading...</div>
            </div>
            <div class="insight-item">
                <div class="insight-label">Last 4 Real Races (starter %):</div>
                <div class="insight-value" id="lastFourTrend">Loading...</div>
            </div>
        </div>

        <div class="data-table">
            <div class="table-title">Overall Outcomes by Year (Starters Only, DNS Excluded from %)</div>
            <table>
                <thead>
                    <tr>
                        <th>Year</th>
                        <th>Starters</th>
                        <th>DNS</th>
                        <th>50K Finish</th>
                        <th>Marathon Finish</th>
                        <th>DNF</th>
                        <th>DQ</th>
                        <th>50K %</th>
                        <th>Marathon %</th>
                        <th>DNF %</th>
                        <th>DQ %</th>
                    </tr>
                </thead>
                <tbody id="outcomeTable">
                    <tr><td colspan="11" style="text-align: center;">Loading data...</td></tr>
                </tbody>
            </table>
        </div>

        <div class="data-table">
            <div class="table-title">Year-by-Year Summary</div>
            <table>
                <thead>
                    <tr>
                        <th>Year</th>
                        <th>Marathon Participants</th>
                        <th>Marathon Finishers</th>
                        <th>Finish Rate</th>
                        <th>50K Participants</th>
                        <th>50K Finishers</th>
                        <th>Finish Rate</th>
                    </tr>
                </thead>
                <tbody id="summaryTable">
                    <tr><td colspan="7" style="text-align: center;">Loading data...</td></tr>
                </tbody>
            </table>
        </div>

        <div class="data-table">
            <div class="table-title">üèÜ 2026 Registered Veterans (50K+ Finishers)</div>
            <p style="margin-bottom: 15px; color: #666; font-size: 0.95em;">
                These runners are registered for 2026 and have a history of 50K finishes. 
                <strong>Reliability Index</strong> = (50K finishes √ó 15) + (years √ó 10) - (marathons √ó 5). 
                <strong>Pace Tier</strong> based on avg finish time from last 4 years (2022-2025).
            </p>
            
            <div style="margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 15px; align-items: center;">
                <div>
                    <label for="paceFilter" style="margin-right: 10px; font-weight: 500;">Filter by Pace Tier:</label>
                    <select id="paceFilter" onchange="filterRegisteredVeterans()" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                        <option value="all">All Pace Tiers</option>
                        <option value="Elite (Top 25%)">Elite (Top 25%)</option>
                        <option value="Fast (Top 50%)">Fast (Top 50%)</option>
                        <option value="Steady (Top 75%)">Steady (Top 75%)</option>
                        <option value="Conservative (Back 25%)">Conservative (Back 25%)</option>
                    </select>
                </div>
                <label style="display: inline-flex; align-items: center; gap: 8px; font-weight: 500;">
                    <input type="checkbox" id="includeMarathonOnly" onchange="filterRegisteredVeterans()" />
                    Include marathon-only (0 50K finishes)
                </label>
            </div>
            
            <table id="registeredVeteransTable">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Name</th>
                        <th>Age</th>
                        <th>Location</th>
                        <th>RI</th>
                        <th>Years</th>
                        <th>50K</th>
                        <th>Pace Tier</th>
                        <th>Avg Time (Recent)</th>
                        <th>Recent Performance (2022-2025)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="10" style="text-align: center;">Loading 2026 veterans...</td></tr>
                </tbody>
            </table>
        </div>

        <div class="data-table">
            <div class="table-title" style="cursor: pointer; user-select: none;" onclick="toggleVeteransTable()">
                üèÜ Barkley Veterans - Multi-Year Participants <span id="expandToggle" style="float: right; font-size: 0.8em; color: #999;">[Show More]</span>
            </div>
            
            <div class="stats-grid" style="margin-bottom: 20px;">
                <div class="stat-card">
                    <div class="stat-label">Total Veterans</div>
                    <div class="stat-value" id="totalVeterans">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Most Participations</div>
                    <div class="stat-value" id="maxParticipations">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">10+ Year Veterans</div>
                    <div class="stat-value" id="tenYearVets">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Perfect Finishers</div>
                    <div class="stat-value" id="perfectFinishers">--</div>
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <label for="veteranFilter" style="margin-right: 10px; font-weight: 500;">Filter:</label>
                <select id="veteranFilter" onchange="filterVeterans()" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                    <option value="all">All Veterans (2+ races)</option>
                    <option value="3">3+ Participations</option>
                    <option value="5">5+ Participations</option>
                    <option value="7">7+ Participations</option>
                    <option value="10">10+ Participations</option>
                    <option value="perfect">100% Finish Rate</option>
                </select>
            </div>

            <div id="veteransTableContainer" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px;">
            <table id="veteransTable">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Name</th>
                        <th>Total Races</th>
                        <th>50K Finishes</th>
                        <th>Marathon Finishes</th>
                        <th>Years Active</th>
                        <th>DNF</th>
                        <th>DNS</th>
                        <th>Finish Rate</th>
                        <th>Best Time</th>
                        <th>Best Place</th>
                        <th>Location</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="12" style="text-align: center;">Loading veterans...</td></tr>
                </tbody>
            </table>
            </div>
            <div style="text-align: center; padding: 15px; background: #f9f9f9; border-top: 1px solid #ddd; cursor: pointer;" onclick="toggleVeteransTable()">
                <span id="expandText">Show all veterans ‚ñº</span>
            </div>
        </div>
    </div>

    <footer>
        <p>üìà Historical data scraped from UltraSignup | Updated: <span id="lastUpdate">-</span></p>
    </footer>

    <script>
        // Data structure to hold all historical data
        const historicalData = {};
        let allYears = [];
        const incompleteYears = [2016, 2017]; // Years with missing DNF data on UltraSignup
        const excludedFromAggregates = [2016, 2017, 2020]; // Skip these for aggregate stats (DNF missing or virtual year)
        let veteransExpanded = false;

        // Load all historical data
        async function loadHistoricalData() {
            try {
                // Load all result files
                for (let year = 2015; year <= 2025; year++) {
                    for (const distance of ['50k', 'marathon']) {
                        try {
                            const response = await fetch(`data/historical/results/results_${year}_${distance}.json`);
                            if (response.ok) {
                                const data = await response.json();
                                if (!historicalData[year]) {
                                    historicalData[year] = {};
                                }
                                historicalData[year][distance] = data;
                            }
                        } catch (e) {
                            console.log(`No data for ${year} ${distance}`);
                        }
                    }
                }

                allYears = Object.keys(historicalData).map(y => parseInt(y)).sort((a, b) => a - b);
                console.log('Loaded data for years:', allYears);
                
                generateAnalysis();
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        function calculateStats() {
            let totalStarters = 0;
            let totalFinishers50k = 0;
            let totalFinishersMarathon = 0;
            let totalDnf = 0;

            allYears.forEach(year => {
                if (excludedFromAggregates.includes(year)) {
                    // Skip incomplete years for aggregate stats to avoid skew
                    return;
                }
                const yearData = historicalData[year];
                if (yearData.marathon) {
                    const m = yearData.marathon;
                    const starters = (m.total_finishers + m.total_dnf + m.total_disqualified);
                    totalStarters += starters;
                    totalFinishersMarathon += m.total_finishers;
                    totalDnf += m.total_dnf;
                }
                if (yearData['50k']) {
                    const k = yearData['50k'];
                    const starters = (k.total_finishers + k.total_dnf + k.total_disqualified);
                    totalStarters += starters;
                    totalFinishers50k += k.total_finishers;
                    totalDnf += k.total_dnf;
                }
            });

            const pct50k = totalStarters > 0 ? ((totalFinishers50k / totalStarters) * 100).toFixed(1) : 0;
            const pctMarathon = totalStarters > 0 ? ((totalFinishersMarathon / totalStarters) * 100).toFixed(1) : 0;
            const pctDnf = totalStarters > 0 ? ((totalDnf / totalStarters) * 100).toFixed(1) : 0;

            document.getElementById('totalStarters').textContent = totalStarters.toLocaleString();
            document.getElementById('totalFinishers50k').textContent = totalFinishers50k.toLocaleString();
            document.getElementById('totalFinishersMarathon').textContent = totalFinishersMarathon.toLocaleString();
            document.getElementById('totalDnf').textContent = totalDnf.toLocaleString();
            document.getElementById('pct50k').textContent = `${pct50k}% of starters`;
            document.getElementById('pctMarathon').textContent = `${pctMarathon}% of starters`;
            document.getElementById('pctDnf').textContent = `${pctDnf}% of starters`;
        }

        function generateOutcomeStackedChart() {
            const years = [];
            const pct50k = [];
            const pctMarathon = [];
            const pctDnf = [];
            const pctDq = [];
            const count50k = [];
            const countMarathon = [];
            const countDnf = [];
            const countDq = [];
            const startCounts = [];

            allYears.forEach(year => {
                const m = historicalData[year]?.marathon || {};
                const k = historicalData[year]?.['50k'] || {};

                const starters = (m.total_finishers || 0) + (m.total_dnf || 0) + (m.total_disqualified || 0)
                    + (k.total_finishers || 0) + (k.total_dnf || 0) + (k.total_disqualified || 0);
                years.push(year.toString());
                startCounts.push(starters);

                if (starters > 0) {
                    const c50k = k.total_finishers || 0;
                    const cMar = m.total_finishers || 0;
                    const cDnf = (m.total_dnf || 0) + (k.total_dnf || 0);
                    const cDq = (m.total_disqualified || 0) + (k.total_disqualified || 0);
                    count50k.push(c50k);
                    countMarathon.push(cMar);
                    countDnf.push(cDnf);
                    countDq.push(cDq);
                    pct50k.push(((c50k) / starters * 100).toFixed(2));
                    pctMarathon.push(((cMar) / starters * 100).toFixed(2));
                    pctDnf.push((( cDnf ) / starters * 100).toFixed(2));
                    pctDq.push((( cDq ) / starters * 100).toFixed(2));
                } else {
                    count50k.push(0); countMarathon.push(0); countDnf.push(0); countDq.push(0);
                    pct50k.push(0); pctMarathon.push(0); pctDnf.push(0); pctDq.push(0);
                }
            });

            const ctx = document.getElementById('outcomeStackedChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: years,
                    datasets: [
                        { label: '50K Finish', data: pct50k, backgroundColor: '#CC9E1D', stack: 'outcome' },
                        { label: 'Marathon Finish', data: pctMarathon, backgroundColor: '#7AA356', stack: 'outcome' },
                        { label: 'DNF', data: pctDnf, backgroundColor: '#e74c3c', stack: 'outcome' },
                        { label: 'DQ', data: pctDq, backgroundColor: '#f1c40f', stack: 'outcome' },
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { stacked: true },
                        y: { stacked: true, beginAtZero: true, max: 100, title: { display: true, text: 'Percent of Starters' } }
                    },
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    const yearIdx = context.dataIndex;
                                    const totalStarters = startCounts[yearIdx];
                                    let count = 0;
                                    if (context.dataset.label === '50K Finish') count = count50k[yearIdx];
                                    else if (context.dataset.label === 'Marathon Finish') count = countMarathon[yearIdx];
                                    else if (context.dataset.label === 'DNF') count = countDnf[yearIdx];
                                    else if (context.dataset.label === 'DQ') count = countDq[yearIdx];
                                    const pct = context.parsed.y || 0;
                                    return `${context.dataset.label}: ${count} finishers (${pct}%)`;
                                }
                            }
                        },
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        function generateFinishRateChart() {
            const years = [];
            const marathonRates = [];
            const fiftyKRates = [];

            allYears.forEach(year => {
                years.push(year.toString());
                
                if (historicalData[year] && historicalData[year].marathon) {
                    const m = historicalData[year].marathon;
                    const starters = m.total_finishers + m.total_dnf + m.total_disqualified;
                    marathonRates.push(starters > 0 ? ((m.total_finishers / starters) * 100).toFixed(1) : 0);
                }
                
                if (historicalData[year] && historicalData[year]['50k']) {
                    const k = historicalData[year]['50k'];
                    const starters = k.total_finishers + k.total_dnf + k.total_disqualified;
                    fiftyKRates.push(starters > 0 ? ((k.total_finishers / starters) * 100).toFixed(1) : 0);
                }
            });

            const ctx = document.getElementById('finishRateChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: years,
                    datasets: [
                        {
                            label: 'Marathon Finish Rate (%)',
                            data: marathonRates,
                            backgroundColor: '#667eea',
                        },
                        {
                            label: '50K Finish Rate (%)',
                            data: fiftyKRates,
                            backgroundColor: '#f39c12',
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: { display: true, text: 'Finish Rate (%)' }
                        }
                    }
                }
            });
        }

        function generateStatusChart() {
            // Use most recent year (2025) for status breakdown
            const year = Math.max(...allYears);
            const data = historicalData[year];
            
            if (!data || !data.marathon) return;

            const m = data.marathon;
            const ctx = document.getElementById('statusChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Finished', 'DNF', 'DNS'],
                    datasets: [{
                        data: [m.total_finishers, m.total_dnf, m.total_dns],
                        backgroundColor: [
                            '#27ae60',
                            '#e74c3c',
                            '#f39c12'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function generateInsights() {
            let marathonRates = [];
            let mostChallenging = { year: 0, rate: 100 };
            let bestYear = { year: 0, rate: 0 };

            allYears.forEach(year => {
                if (excludedFromAggregates.includes(year)) {
                    return;
                }
                if (historicalData[year] && historicalData[year].marathon) {
                    const m = historicalData[year].marathon;
                    const starters = m.total_finishers + m.total_dnf + m.total_disqualified;
                    const rate = starters > 0 ? (m.total_finishers / starters) * 100 : 0;
                    marathonRates.push(rate);

                    if (rate < mostChallenging.rate) {
                        mostChallenging = { year, rate: rate.toFixed(1) };
                    }
                    if (rate > bestYear.rate) {
                        bestYear = { year, rate: rate.toFixed(1) };
                    }
                }
            });

            const trend = marathonRates.length > 1 
                ? (marathonRates[marathonRates.length - 1] > marathonRates[marathonRates.length - 5] 
                    ? 'üìà Getting harder' 
                    : 'üìâ Getting easier')
                : 'Insufficient data';

            let fiftyKInsight = '';
            allYears.forEach(year => {
                if (excludedFromAggregates.includes(year)) {
                    return;
                }
                if (historicalData[year] && historicalData[year]['50k']) {
                    const k = historicalData[year]['50k'];
                    const starters = k.total_finishers + k.total_dnf + k.total_disqualified;
                    const rate = starters > 0 ? ((k.total_finishers / starters) * 100).toFixed(1) : 0;
                    fiftyKInsight = `Consistently high finish rates (avg ~${rate}% in recent years)`;
                }
            });

            document.getElementById('difficultyTrend').textContent = trend;
            document.getElementById('mostChallenging').textContent = `${mostChallenging.year} (${mostChallenging.rate}% finish rate)`;
            document.getElementById('bestYear').textContent = `${bestYear.year} (${bestYear.rate}% finish rate)`;
            document.getElementById('fiftyKInsight').textContent = fiftyKInsight;
            document.getElementById('lastFourTrend').textContent = buildLastFourTrend();
        }

        function buildLastFourTrend() {
            // Exclude years marked in excludedFromAggregates (missing DNF or virtual)
            const validYears = allYears.filter(y => !excludedFromAggregates.includes(y)).sort((a,b)=>a-b);
            const lastFour = validYears.slice(-4);
            if (!lastFour.length) return 'No data';

            let starters = 0, finish50k = 0, finishMar = 0, dnf = 0, dq = 0;
            lastFour.forEach(year => {
                const m = historicalData[year]?.marathon || {};
                const k = historicalData[year]?.['50k'] || {};
                starters += (m.total_finishers || 0) + (m.total_dnf || 0) + (m.total_disqualified || 0)
                         + (k.total_finishers || 0) + (k.total_dnf || 0) + (k.total_disqualified || 0);
                finish50k += (k.total_finishers || 0);
                finishMar += (m.total_finishers || 0);
                dnf += (m.total_dnf || 0) + (k.total_dnf || 0);
                dq += (m.total_disqualified || 0) + (k.total_disqualified || 0);
            });

            if (starters === 0) return 'No data';
            const pct = v => ((v / starters) * 100).toFixed(1);
            return `${lastFour.join(', ')} ‚Üí 50K ${pct(finish50k)}%, Marathon ${pct(finishMar)}%, DNF ${pct(dnf)}%, DQ ${pct(dq)}% (of starters)`;
        }

        function generateSummaryTable() {
            const tbody = document.getElementById('summaryTable');
            tbody.innerHTML = '';

            allYears.forEach(year => {
                const m = historicalData[year]?.marathon || {};
                const k = historicalData[year]?.['50k'] || {};

                const mTotal = m.total_finishers ? (m.total_finishers + m.total_dnf + m.total_disqualified) : 0;
                const kTotal = k.total_finishers ? (k.total_finishers + k.total_dnf + k.total_disqualified) : 0;
                const mRate = mTotal > 0 ? ((m.total_finishers / mTotal) * 100).toFixed(1) : '-';
                const kRate = kTotal > 0 ? ((k.total_finishers / kTotal) * 100).toFixed(1) : '-';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${year}</strong></td>
                    <td>${mTotal}</td>
                    <td>${m.total_finishers || 0}</td>
                    <td><span class="${mRate !== '-' && parseFloat(mRate) > 30 ? 'finish-rate' : 'low-finish-rate'}">${mRate}%</span></td>
                    <td>${kTotal}</td>
                    <td>${k.total_finishers || 0}</td>
                    <td><span class="${kRate !== '-' && parseFloat(kRate) > 50 ? 'finish-rate' : 'low-finish-rate'}">${kRate}%</span></td>
                `;
                tbody.appendChild(row);
            });

            document.getElementById('lastUpdate').textContent = new Date().toLocaleDateString();
        }

        function generateOutcomeTable() {
            const tbody = document.getElementById('outcomeTable');
            tbody.innerHTML = '';

            allYears.forEach(year => {
                const m = historicalData[year]?.marathon || {};
                const k = historicalData[year]?.['50k'] || {};

                const starters = (m.total_finishers || 0) + (m.total_dnf || 0) + (m.total_disqualified || 0)
                    + (k.total_finishers || 0) + (k.total_dnf || 0) + (k.total_disqualified || 0);
                const dns = (m.total_dns || 0) + (k.total_dns || 0);
                const finish50k = k.total_finishers || 0;
                const finishMar = m.total_finishers || 0;
                const dnf = (m.total_dnf || 0) + (k.total_dnf || 0);
                const dq = (m.total_disqualified || 0) + (k.total_disqualified || 0);

                const pct = starters > 0 ? (val => ((val / starters) * 100).toFixed(2)) : () => '0.00';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${year}</strong></td>
                    <td>${starters}</td>
                    <td>${dns}</td>
                    <td>${finish50k}</td>
                    <td>${finishMar}</td>
                    <td>${dnf}</td>
                    <td>${dq}</td>
                    <td>${pct(finish50k)}%</td>
                    <td>${pct(finishMar)}%</td>
                    <td>${pct(dnf)}%</td>
                    <td>${pct(dq)}%</td>
                `;
                tbody.appendChild(row);
            });
        }

        function generateAnalysis() {
            calculateStats();
            generateOutcomeStackedChart();
            generateFinishRateChart();
            generateStatusChart();
            generateInsights();
            generateSummaryTable();
            generateOutcomeTable();
            loadVeterans();
        }

        // Veterans functionality
        let allVeterans = [];

        async function loadVeterans() {
            try {
                const response = await fetch(`data/historical/analysis/veterans.json?t=${Date.now()}`, { cache: 'no-store' });
                if (response.ok) {
                    allVeterans = await response.json();
                    renderVeteransStats();
                    renderVeteransTable(allVeterans);
                }
            } catch (error) {
                console.error('Error loading veterans data:', error);
            }
        }

        function renderVeteransStats() {
            const veterans = allVeterans;
            document.getElementById('totalVeterans').textContent = veterans.length;
            
            const maxParticipations = Math.max(...veterans.map(v => v.total_participations), 0);
            document.getElementById('maxParticipations').textContent = maxParticipations;
            
            const tenYearVets = veterans.filter(v => v.total_participations >= 10).length;
            document.getElementById('tenYearVets').textContent = tenYearVets;
            
            const perfectFinishers = veterans.filter(v => v.finish_rate === 100 && v.total_participations >= 2).length;
            document.getElementById('perfectFinishers').textContent = perfectFinishers;
        }

        function renderVeteransTable(veterans) {
            const tbody = document.querySelector('#veteransTable tbody');
            tbody.innerHTML = veterans.map((vet, index) => `
                <tr>
                    <td style="text-align: center;">${index + 1}</td>
                    <td><strong>${vet.name}</strong></td>
                    <td style="text-align: center;">${vet.total_participations}</td>
                    <td style="text-align: center; color: #8b5cf6;">${vet.finishes_50k || 0} / ${vet.races_50k || 0}</td>
                    <td style="text-align: center; color: #f59e0b;">${vet.finishes_marathon || 0} / ${vet.races_marathon || 0}</td>
                    <td>${vet.year_range}</td>
                    <td style="text-align: center; color: #ef4444;">${vet.dnf}</td>
                    <td style="text-align: center; color: #fbbf24;">${vet.dns}</td>
                    <td style="text-align: center;"><strong>${vet.finish_rate}%</strong></td>
                    <td style="text-align: center;">${vet.best_time_formatted || '--'}</td>
                    <td style="text-align: center;">${vet.best_place || '--'}</td>
                    <td>${vet.location}</td>
                </tr>
            `).join('');
        }

        function filterVeterans() {
            const filterValue = document.getElementById('veteranFilter').value;
            let filtered = allVeterans;

            if (filterValue === 'all') {
                filtered = allVeterans;
            } else if (filterValue === 'perfect') {
                filtered = allVeterans.filter(v => v.finish_rate === 100);
            } else {
                const minRaces = parseInt(filterValue);
                filtered = allVeterans.filter(v => v.total_participations >= minRaces);
            }

            renderVeteransTable(filtered);
        }

        function toggleVeteransTable() {
            const container = document.getElementById('veteransTableContainer');
            const expandText = document.getElementById('expandText');
            const expandToggle = document.getElementById('expandToggle');
            
            veteransExpanded = !veteransExpanded;
            
            if (veteransExpanded) {
                container.style.maxHeight = 'none';
                expandText.textContent = 'Show less ‚ñ≤';
                expandToggle.textContent = '[Show Less]';
            } else {
                container.style.maxHeight = '400px';
                expandText.textContent = 'Show all veterans ‚ñº';
                expandToggle.textContent = '[Show More]';
            }
        }

        let registeredVeteransData = [];

        async function loadRegisteredVeterans() {
            try {
                const response = await fetch('data/veterans_2026.json');
                if (!response.ok) throw new Error('Failed to load veterans data');
                
                const data = await response.json();
                registeredVeteransData = data.veterans || [];
                filterRegisteredVeterans();
            } catch (error) {
                console.error('Error loading registered veterans:', error);
                document.querySelector('#registeredVeteransTable tbody').innerHTML = 
                    '<tr><td colspan="9" style="text-align: center; color: #999;">No veteran data available</td></tr>';
            }
        }

        function filterRegisteredVeterans() {
            const paceFilter = document.getElementById('paceFilter').value;
            const includeMarathonOnly = document.getElementById('includeMarathonOnly').checked;

            let filtered = registeredVeteransData.filter(v => {
                const finishes50k = v.experience['50k_finishes'] || 0;
                return includeMarathonOnly ? true : finishes50k > 0;
            });

            if (paceFilter !== 'all') {
                filtered = filtered.filter(v => v.experience.pace_tier === paceFilter);
            }

            renderRegisteredVeterans(filtered);
        }

        function renderRegisteredVeterans(veterans) {
            const tbody = document.querySelector('#registeredVeteransTable tbody');
            
            if (veterans.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; color: #999;">No veterans match this filter</td></tr>';
                return;
            }
            
            tbody.innerHTML = veterans.slice(0, 50).map((vet, idx) => {
                const reliabilityClass = vet.experience.reliability_index >= 200 ? 'style="background-color: #fef3c7;"' :
                                        vet.experience.reliability_index >= 150 ? 'style="background-color: #dbeafe;"' : '';
                
                const paceColor = vet.experience.pace_tier === 'Elite (Top 25%)' ? '#16a34a' :
                                 vet.experience.pace_tier === 'Fast (Top 50%)' ? '#2563eb' :
                                 vet.experience.pace_tier === 'Steady (Top 75%)' ? '#f59e0b' :
                                 vet.experience.pace_tier === 'Conservative (Back 25%)' ? '#9333ea' : '#666';
                
                const recentCount = vet.experience.recent_finishes_count || 0;
                const recentMarathonCount = vet.experience.recent_marathon_count || 0;
                const recentSummary = vet.experience.recent_summary || 'No recent data';
                
                // Color code the recent summary
                let summaryHtml = recentSummary;
                if (recentSummary !== 'No recent data' && recentSummary !== 'No recent finishes') {
                    summaryHtml = recentSummary
                        .replace(/50K/g, '<span style="color: #CC9E1D; font-weight: bold;">50K</span>')
                        .replace(/Marathon/g, '<span style="color: #7AA356;">Marathon</span>')
                        .replace(/DNF/g, '<span style="color: #e74c3c; font-weight: bold;">DNF</span>');
                }
                
                return `
                    <tr ${reliabilityClass}>
                        <td style="text-align: center; font-weight: bold;">${idx + 1}</td>
                        <td><strong>${vet.name.first} ${vet.name.last}</strong></td>
                        <td style="text-align: center;">${vet.age_category || 'N/A'}</td>
                        <td style="font-size: 0.9em;">${vet.location.city || ''}, ${vet.location.state || ''}</td>
                        <td style="text-align: center; font-weight: bold; color: #8b5cf6; font-size: 1.1em;">${vet.experience.reliability_index}</td>
                        <td style="text-align: center;">${vet.experience.years_participated}</td>
                        <td style="text-align: center; color: #CC9E1D; font-weight: bold;">${vet.experience['50k_finishes']}</td>
                        <td style="text-align: center; color: ${paceColor}; font-weight: 500; font-size: 0.85em;">${vet.experience.pace_tier || 'N/A'}</td>
                        <td style="text-align: center; font-weight: bold;">${vet.experience.avg_recent_time_formatted || 'N/A'}</td>
                        <td style="font-size: 0.85em; text-align: center;">${summaryHtml}</td>
                    </tr>
                `;
            }).join('');
        }

        // Load data when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadHistoricalData();
            loadRegisteredVeterans();
        });
    </script>
</body>
</html>
