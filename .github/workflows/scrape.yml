name: Daily Entrant Scraper

permissions:
  contents: write
  issues: write

on:
  schedule:
    # run daily at 08:00 UTC (single consolidated workflow)
    - cron: '0 8 * * *'
  workflow_dispatch:

jobs:
  scrape:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run all scrapers
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          NOTIFY_FROM: ${{ secrets.NOTIFY_FROM }}
          NOTIFY_TO: ${{ secrets.NOTIFY_TO }}
        run: |
          python3 scripts/run_all.py

      - name: Check for meaningful changes
        id: check_changes
        run: |
          python3 scripts/check_changes.py
          echo "has_changes=$?" >> $GITHUB_OUTPUT

      - name: Commit data changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/* || true
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update entrant data via scheduled scrape"
            git push
          fi

      - name: Create issue for entrant changes
        if: steps.check_changes.outputs.has_changes == '0'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const events = ['frozen_head_50k', 'other_race_50m', 'other_race_55k'];
            const eventNames = {
              'frozen_head_50k': 'Barkley Fall Classic',
              'other_race_50m': 'Dam Yeti 50 Miler',
              'other_race_55k': 'Dam Yeti 55K'
            };
            
            let body = '## Entrant List Changes Detected\n\n';
            let hasChanges = false;
            
            for (const key of events) {
              const changesFile = `data/changes_${key}.json`;
              if (!fs.existsSync(changesFile)) continue;
              
              const changes = JSON.parse(fs.readFileSync(changesFile, 'utf8'));
              if (changes.length === 0) continue;
              
              const latest = changes[changes.length - 1];
              if (latest.total_new > 0 || latest.total_dropped > 0) {
                hasChanges = true;
                body += `### ${eventNames[key]}\n`;
                body += `- **Current count:** ${latest.new_count}\n`;
                body += `- **New entrants:** ${latest.total_new}\n`;
                body += `- **Dropped entrants:** ${latest.total_dropped}\n`;
                body += `- **Net change:** ${latest.count_change > 0 ? '+' : ''}${latest.count_change}\n`;
                body += `- **Time:** ${new Date(latest.timestamp).toLocaleString()}\n\n`;
              }
            }
            
            if (hasChanges) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ğŸƒ Entrant List Update - ${new Date().toLocaleDateString()}`,
                body: body,
                labels: ['entrant-update', 'automated']
              });
            }
